<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุจูุงุก ุงูุณูุฑุฉ ุงูุฐุงุชูุฉ - My CV</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800;900&family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/builder.css">
</head>

<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <img src="images/logo.png" alt="My CV" class="logo-img"
                    style="height:40px;width:auto;border-radius:8px">
                <span class="logo-text">My CV</span>
            </a>
            <div class="nav-links">
                <a href="index.html" class="nav-link" data-i18n="nav.home">ุงูุฑุฆูุณูุฉ</a>
                <a href="index.html#templates" class="nav-link" data-i18n="nav.templates">ุงูููุงูุจ</a>
                <a href="index.html#pricing" class="nav-link" data-i18n="nav.pricing">ุงูุฃุณุนุงุฑ</a>
            </div>
            <div class="nav-controls">
                <div class="lang-switcher">
                    <button class="lang-btn active" data-lang="ar">ุน</button>
                    <button class="lang-btn" data-lang="en">EN</button>
                </div>
                <button class="theme-toggle" id="themeToggle"><i class="fas fa-moon"></i></button>
            </div>
        </div>
    </nav>

    <!-- Progress Bar -->
    <div class="cv-progress-container">
        <div class="cv-progress-bar">
            <div class="cv-progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
        <div class="cv-progress-info">
            <span class="cv-progress-text">ุฅููุงู ุงูุณูุฑุฉ: <strong id="progressPercent">0%</strong></span>
            <span class="cv-progress-tip" id="progressTip">๐ก ุงุจุฏุฃ ุจุฅุถุงูุฉ ูุนูููุงุชู ุงูุดุฎุตูุฉ</span>
        </div>
    </div>

    <!-- Smart Tips Panel -->
    <div class="smart-tips-panel" id="smartTipsPanel">
        <div class="smart-tips-header">
            <span><i class="fas fa-lightbulb"></i> ูุตุงุฆุญ ุฐููุฉ</span>
            <button onclick="toggleTipsPanel()" class="tips-close"><i class="fas fa-times"></i></button>
        </div>
        <div class="smart-tips-content" id="smartTipsContent">
            <div class="tip-item">๐ก ุฃุถู ุตูุฑุฉ ุงุญุชุฑุงููุฉ ุจุฎูููุฉ ุจูุถุงุก</div>
        </div>
    </div>

    <div class="builder-container">
        <aside class="builder-sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-edit"></i> <span data-i18n="builder.title">ุจูุงูุงุช ุงูุณูุฑุฉ ุงูุฐุงุชูุฉ</span></h2>
            </div>

            <form id="cvForm" class="cv-form">
                <!-- Personal Info -->
                <div class="form-section" data-section="personal">
                    <div class="section-header-form">
                        <h3><i class="fas fa-user"></i> <span data-i18n="builder.personal">ุงููุนูููุงุช ุงูุดุฎุตูุฉ</span></h3>
                        <button type="button" class="section-toggle"><i class="fas fa-chevron-up"></i></button>
                    </div>
                    <div class="section-content">
                        <div class="form-group">
                            <label data-i18n="builder.photo">ุงูุตูุฑุฉ ุงูุดุฎุตูุฉ</label>
                            <div class="photo-upload" id="photoUpload">
                                <input type="file" id="photoInput" accept="image/*" hidden>
                                <div class="photo-preview" id="photoPreview">
                                    <i class="fas fa-camera"></i>
                                    <span>ุงุฎุชุฑ ุตูุฑุฉ</span>
                                </div>
                            </div>
                            <div class="form-group" style="margin-top:10px">
                                <input type="url" id="photoUrl" placeholder="https://example.com/photo.jpg"
                                    onchange="loadPhotoFromUrl(this.value)">
                                <small style="color:var(--text-muted)" data-i18n="builder.photoUrl">ุฃู ุฃุฏุฎู ุฑุงุจุท
                                    ุงูุตูุฑุฉ</small>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label data-i18n="builder.firstName">ุงูุงุณู ุงูุฃูู</label><input
                                    type="text" id="firstName" placeholder="ุฃุญูุฏ"></div>
                            <div class="form-group"><label data-i18n="builder.lastName">ุงุณู ุงูุนุงุฆูุฉ</label><input
                                    type="text" id="lastName" placeholder="ูุญูุฏ"></div>
                        </div>
                        <div class="form-group"><label data-i18n="builder.jobTitle">ุงููุณูู ุงููุธููู</label><input
                                type="text" id="jobTitle" placeholder="ูููุฏุณ ุจุฑูุฌูุงุช"></div>
                        <div class="form-row">
                            <div class="form-group"><label data-i18n="builder.email">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label><input
                                    type="email" id="email" placeholder="email@example.com"></div>
                            <div class="form-group"><label data-i18n="builder.phone">ุฑูู ุงูุฌูุงู</label><input type="tel"
                                    id="phone" placeholder="+966 5xxxxxxxx"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label data-i18n="builder.location">ุงููููุน</label><input type="text"
                                    id="location" placeholder="ุงูุฑูุงุถุ ุงูุณุนูุฏูุฉ"></div>
                            <div class="form-group"><label>LinkedIn</label><input type="url" id="linkedin"
                                    placeholder="linkedin.com/in/username"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label data-i18n="builder.website">ุงููููุน ุงูุดุฎุตู</label><input
                                    type="url" id="website" placeholder="mywebsite.com"></div>
                            <div class="form-group"><label>GitHub</label><input type="url" id="github"
                                    placeholder="github.com/username"></div>
                        </div>
                        <div class="form-group"><label data-i18n="builder.summary">ูุจุฐุฉ ุดุฎุตูุฉ</label><textarea
                                id="summary" rows="4" placeholder="ุงูุชุจ ูุจุฐุฉ ุงุญุชุฑุงููุฉ ุนู ููุณู ูุฎุจุฑุงุชู..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Experience -->
                <div class="form-section" data-section="experience">
                    <div class="section-header-form">
                        <h3><i class="fas fa-briefcase"></i> <span data-i18n="builder.experience">ุงูุฎุจุฑุงุช ุงูุนูููุฉ</span>
                        </h3>
                        <button type="button" class="section-toggle"><i class="fas fa-chevron-up"></i></button>
                    </div>
                    <div class="section-content">
                        <div id="experienceContainer"></div>
                        <button type="button" class="btn-add" onclick="addExperience()"><i class="fas fa-plus"></i>
                            <span data-i18n="builder.addExperience">ุฅุถุงูุฉ ุฎุจุฑุฉ</span></button>
                    </div>
                </div>

                <!-- Education -->
                <div class="form-section" data-section="education">
                    <div class="section-header-form">
                        <h3><i class="fas fa-graduation-cap"></i> <span data-i18n="builder.education">ุงูุชุนููู</span>
                        </h3>
                        <button type="button" class="section-toggle"><i class="fas fa-chevron-up"></i></button>
                    </div>
                    <div class="section-content">
                        <div id="educationContainer"></div>
                        <button type="button" class="btn-add" onclick="addEducation()"><i class="fas fa-plus"></i> <span
                                data-i18n="builder.addEducation">ุฅุถุงูุฉ ุชุนููู</span></button>
                    </div>
                </div>

                <!-- Skills -->
                <div class="form-section" data-section="skills">
                    <div class="section-header-form">
                        <h3><i class="fas fa-cogs"></i> <span data-i18n="builder.skills">ุงูููุงุฑุงุช</span></h3>
                        <button type="button" class="section-toggle"><i class="fas fa-chevron-up"></i></button>
                    </div>
                    <div class="section-content">
                        <div id="skillsContainer"></div>
                        <button type="button" class="btn-add" onclick="addSkill()"><i class="fas fa-plus"></i> <span
                                data-i18n="builder.addSkill">ุฅุถุงูุฉ ููุงุฑุฉ</span></button>
                    </div>
                </div>

                <!-- Languages -->
                <div class="form-section" data-section="languages">
                    <div class="section-header-form">
                        <h3><i class="fas fa-language"></i> <span data-i18n="builder.languages">ุงููุบุงุช</span></h3>
                        <button type="button" class="section-toggle"><i class="fas fa-chevron-up"></i></button>
                    </div>
                    <div class="section-content">
                        <div id="languagesContainer"></div>
                        <button type="button" class="btn-add" onclick="addLanguage()"><i class="fas fa-plus"></i> <span
                                data-i18n="builder.addLanguage">ุฅุถุงูุฉ ูุบุฉ</span></button>
                    </div>
                </div>

                <!-- Certifications -->
                <div class="form-section" data-section="certifications">
                    <div class="section-header-form">
                        <h3><i class="fas fa-certificate"></i> <span data-i18n="builder.certifications">ุงูุดูุงุฏุงุช</span>
                        </h3>
                        <button type="button" class="section-toggle"><i class="fas fa-chevron-up"></i></button>
                    </div>
                    <div class="section-content">
                        <div id="certificationsContainer"></div>
                        <button type="button" class="btn-add" onclick="addCertification()"><i class="fas fa-plus"></i>
                            <span data-i18n="builder.addCertification">ุฅุถุงูุฉ ุดูุงุฏุฉ</span></button>
                    </div>
                </div>

                <!-- Projects -->
                <div class="form-section" data-section="projects">
                    <div class="section-header-form">
                        <h3><i class="fas fa-folder-open"></i> <span data-i18n="builder.projects">ุงููุดุงุฑูุน</span></h3>
                        <button type="button" class="section-toggle"><i class="fas fa-chevron-up"></i></button>
                    </div>
                    <div class="section-content">
                        <div id="projectsContainer"></div>
                        <button type="button" class="btn-add" onclick="addProject()"><i class="fas fa-plus"></i> <span
                                data-i18n="builder.addProject">ุฅุถุงูุฉ ูุดุฑูุน</span></button>
                    </div>
                </div>

                <!-- Awards -->
                <div class="form-section" data-section="awards">
                    <div class="section-header-form">
                        <h3><i class="fas fa-trophy"></i> <span data-i18n="builder.awards">ุงูุฌูุงุฆุฒ ูุงูุฅูุฌุงุฒุงุช</span>
                        </h3>
                        <button type="button" class="section-toggle"><i class="fas fa-chevron-up"></i></button>
                    </div>
                    <div class="section-content">
                        <div id="awardsContainer"></div>
                        <button type="button" class="btn-add" onclick="addAward()"><i class="fas fa-plus"></i> <span
                                data-i18n="builder.addAward">ุฅุถุงูุฉ ุฌุงุฆุฒุฉ</span></button>
                    </div>
                </div>

                <!-- Interests -->
                <div class="form-section" data-section="interests">
                    <div class="section-header-form">
                        <h3><i class="fas fa-heart"></i> <span data-i18n="builder.interests">ุงูุงูุชูุงูุงุช</span></h3>
                        <button type="button" class="section-toggle"><i class="fas fa-chevron-up"></i></button>
                    </div>
                    <div class="section-content">
                        <div class="form-group">
                            <textarea id="interests" rows="3"
                                placeholder="ุงููุฑุงุกุฉุ ุงูุณูุฑุ ุงูุจุฑูุฌุฉุ ุงูุฑูุงุถุฉ..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- References -->
                <div class="form-section" data-section="references">
                    <div class="section-header-form">
                        <h3><i class="fas fa-users"></i> <span data-i18n="builder.references">ุงููุฑุงุฌุน</span></h3>
                        <button type="button" class="section-toggle"><i class="fas fa-chevron-up"></i></button>
                    </div>
                    <div class="section-content">
                        <div id="referencesContainer"></div>
                        <button type="button" class="btn-add" onclick="addReference()"><i class="fas fa-plus"></i> <span
                                data-i18n="builder.addReference">ุฅุถุงูุฉ ูุฑุฌุน</span></button>
                    </div>
                </div>
            </form>
        </aside>

        <main class="builder-main">
            <div class="preview-header">
                <div class="template-selector">
                    <label data-i18n="builder.template">ุงููุงูุจ:</label>
                    <select id="templateSelect"></select>
                </div>
                <div class="preview-actions">
                    <button class="btn btn-success" onclick="showATSCheck()"
                        style="background: linear-gradient(135deg, #10b981, #059669)">
                        <i class="fas fa-search-plus"></i> <span>ูุญุต ATS</span>
                    </button>
                    <button class="btn btn-glass" onclick="previewCV()"><i class="fas fa-eye"></i> <span
                            data-i18n="builder.preview">ูุนุงููุฉ</span></button>
                    <button class="btn btn-primary" onclick="downloadCV()"><i class="fas fa-download"></i> <span
                            data-i18n="builder.download">ุชุญููู PDF</span></button>
                </div>
            </div>

            <div class="preview-container">
                <div id="cvPreview" class="cv-preview modern"></div>
            </div>
        </main>
    </div>

    <!-- Download Modal -->
    <div class="modal" id="downloadModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('downloadModal')">&times;</button>
            <div class="modal-header">
                <i class="fas fa-download"></i>
                <h2 data-i18n="download.title">ุชุญููู ุงูุณูุฑุฉ ุงูุฐุงุชูุฉ</h2>
            </div>
            <div class="modal-body">
                <div class="download-options" style="grid-template-columns: repeat(4, 1fr)">
                    <div class="download-option" onclick="downloadFree()">
                        <div class="option-icon"><i class="fas fa-gift"></i></div>
                        <h3 data-i18n="download.freeTitle">ูุฌุงูู</h3>
                        <p data-i18n="download.freeDesc">ูุน ุนูุงูุฉ ูุงุฆูุฉ</p>
                        <span class="option-price"><span data-price="0">0</span> <span
                                data-i18n="pricing.currency">ุฑูุงู</span></span>
                    </div>
                    <div class="download-option" onclick="showPayment('single')">
                        <div class="option-icon"><i class="fas fa-file-alt"></i></div>
                        <h3 data-i18n="download.singleTitle">ุชุญููู ูุงุญุฏ</h3>
                        <p data-i18n="download.singleDesc">ุจุฏูู ุนูุงูุฉ ูุงุฆูุฉ</p>
                        <span class="option-price"><span data-price="5">5</span> <span
                                data-i18n="pricing.currency">ุฑูุงู</span></span>
                    </div>
                    <div class="download-option featured" onclick="showPayment('monthly')">
                        <div class="option-badge" data-i18n="download.bestValue">ุงูุฃูุถู ูููุฉ</div>
                        <div class="option-icon"><i class="fas fa-crown"></i></div>
                        <h3 data-i18n="download.monthlyTitle">ุงุดุชุฑุงู ุดูุฑู</h3>
                        <p data-i18n="download.monthlyDesc">ุชุญูููุงุช ุบูุฑ ูุญุฏูุฏุฉ</p>
                        <span class="option-price"><span data-price="29">29</span> <span
                                data-i18n="pricing.currencyMonth">ุฑูุงู/ุดูุฑ</span></span>
                    </div>
                    <div class="download-option" onclick="showPayment('business')" style="border-color: #8b5cf6">
                        <div class="option-badge" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed)">๐ข
                            ููุดุฑูุงุช</div>
                        <div class="option-icon"
                            style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white"><i
                                class="fas fa-building"></i></div>
                        <h3>ุจุงูุฉ ุงูุดุฑูุงุช</h3>
                        <p>50 ูุณุชุฎุฏู + ุชูุงุฑูุฑ</p>
                        <span class="option-price" style="color: #8b5cf6"><span data-price="199">199</span>
                            ุฑูุงู/ุดูุฑ</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal" id="paymentModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('paymentModal')">&times;</button>
            <div class="modal-header">
                <i class="fas fa-credit-card"></i>
                <h2 data-i18n="payment.title">ุฅุชูุงู ุงูุฏูุน</h2>
            </div>
            <div class="modal-body">
                <p class="payment-info" id="paymentInfo"></p>

                <!-- User logged in info -->
                <div class="user-profile-box" id="userProfileBox"
                    style="display:none; background: var(--bg-primary); padding: 15px; border-radius: 10px; margin: 15px 0; display: flex; align-items: center; gap: 15px;">
                    <img id="userAvatar" src="" alt=""
                        style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
                    <div>
                        <div id="userDisplayName" style="font-weight: 600; color: var(--text-primary)"></div>
                        <div id="userDisplayEmail" style="font-size: 12px; color: var(--text-muted)"></div>
                    </div>
                </div>

                <!-- Login section - show when not logged in -->
                <div class="google-login" id="googleLoginSection">
                    <p data-i18n="payment.loginPrompt">ุณุฌู ุฏุฎูู ุจุญุณุงุจู ูุฅุชูุงู ุงูุฏูุน</p>
                    <button class="btn-google" onclick="signInWithGoogle()">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                        <span data-i18n="payment.googleLogin">ุชุณุฌูู ุงูุฏุฎูู ุจู Google</span>
                    </button>
                </div>

                <!-- Payment button - show when logged in -->
                <div class="payment-methods" id="paymentMethods" style="display:none;">
                    <div
                        style="background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(5,150,105,0.1)); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid rgba(16,185,129,0.2);">
                        <p style="color: #10b981; font-weight: 600; margin: 0;"><i class="fas fa-shield-alt"></i> ุณูุชู
                            ุชูุนูู ุงุดุชุฑุงูู ููุฑุงู</p>
                    </div>
                    <button class="btn btn-primary btn-block" onclick="completePurchase()"
                        style="padding: 15px 30px; font-size: 16px;">
                        <i class="fas fa-check-circle"></i> ุชุฃููุฏ ุงูุงุดุชุฑุงู ูุชุญููู ุงูุณูุฑุฉ
                    </button>
                    <p style="text-align: center; margin-top: 10px; font-size: 12px; color: var(--text-muted);">
                        <i class="fas fa-lock"></i> ุจูุงูุงุชู ูุญููุธุฉ ุจุฃูุงู
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal" id="successModal">
        <div class="modal-content success">
            <div class="success-icon"><i class="fas fa-check-circle"></i></div>
            <h2 data-i18n="success.title">ุชู ุจูุฌุงุญ!</h2>
            <p id="successMessage"></p>
            <button class="btn btn-primary" onclick="closeModal('successModal')" data-i18n="success.ok">ุญุณูุงู</button>
        </div>
    </div>

    <!-- ATS Check Modal -->
    <div class="modal" id="atsModal">
        <div class="modal-content" style="max-width: 650px">
            <button class="modal-close" onclick="closeModal('atsModal')">&times;</button>
            <div class="modal-header">
                <h2><i class="fas fa-search-plus" style="color: #10b981"></i> ูุญุต ATS</h2>
            </div>
            <div class="modal-body">
                <div class="ats-score-container">
                    <div class="ats-score-circle" id="atsScoreCircle">
                        <span class="ats-score-number" id="atsScoreNumber">0</span>
                        <span class="ats-score-label">ููุทุฉ</span>
                    </div>
                    <div class="ats-score-status" id="atsScoreStatus">ุฌุงุฑู ุงูุชุญููู...</div>
                </div>
                <div class="ats-details" id="atsDetails">
                    <!-- ุณูุชู ููุคูุง ุจู JavaScript -->
                </div>
                <div class="ats-suggestions" id="atsSuggestions">
                    <h4><i class="fas fa-lightbulb"></i> ุงูุชุฑุงุญุงุช ููุชุญุณูู</h4>
                    <ul id="atsSuggestionsList"></ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- PayPal SDK -->
    <script
        src="https://www.paypal.com/sdk/js?client-id=AftKM03LXGh_GVZOCBRysvtcqhahWPe8ATivLVH0o1eYu55lnggv5FZpGy4be-kE5RCB3b8xUcmdOWUa&currency=USD&locale=ar_SA"></script>

    <!-- Google Sign-In SDK -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <script src="js/i18n.js"></script>
    <script src="js/app.js"></script>
    <script src="js/smart-suggestions.js"></script>
    <script src="js/cv-builder.js"></script>

    <!-- PayPal and Google Integration -->
    <script>
        // Google Client ID
        const GOOGLE_CLIENT_ID = '691185500630-jqe1usmacp4orbg06bbaqdkcq68kn96o.apps.googleusercontent.com';
        let currentUserData = null;

        // Check if user is already logged in
        document.addEventListener('DOMContentLoaded', () => {
            const savedUser = localStorage.getItem('mycv_user');
            if (savedUser) {
                try {
                    currentUserData = JSON.parse(savedUser);
                    isLoggedIn = true;
                } catch (e) { }
            }
        });

        // Initialize Google Sign-In
        function initGoogleSignIn() {
            if (typeof google !== 'undefined' && google.accounts) {
                google.accounts.id.initialize({
                    client_id: GOOGLE_CLIENT_ID,
                    callback: handleGoogleCredentialResponse,
                    auto_select: false,
                    ux_mode: 'popup'
                });
            }
        }

        // Handle Google Sign-In response
        function handleGoogleCredentialResponse(response) {
            const credential = response.credential;
            // Decode JWT to get user info
            const base64Url = credential.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));

            const userInfo = JSON.parse(jsonPayload);

            // Send to backend
            fetch('api/auth.php?action=google', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    google_id: userInfo.sub,
                    email: userInfo.email,
                    name: userInfo.name,
                    avatar: userInfo.picture
                })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        localStorage.setItem('mycv_token', data.token);
                        localStorage.setItem('mycv_user', JSON.stringify(data.user));
                        currentUserData = data.user;
                        isLoggedIn = true;
                        showUserLoggedIn(userInfo);
                        showSuccess('ุชู ุชุณุฌูู ุงูุฏุฎูู ุจูุฌุงุญ!');
                    }
                })
                .catch(err => console.error('Google login error:', err));
        }

        // Show user is logged in
        function showUserLoggedIn(userInfo) {
            // Hide login section
            document.getElementById('googleLoginSection').style.display = 'none';

            // Show user profile
            const profileBox = document.getElementById('userProfileBox');
            if (profileBox) {
                profileBox.style.display = 'flex';
                document.getElementById('userAvatar').src = userInfo.picture || userInfo.avatar || '';
                document.getElementById('userDisplayName').textContent = userInfo.name;
                document.getElementById('userDisplayEmail').textContent = userInfo.email;
            }

            // Show payment button
            document.getElementById('paymentMethods').style.display = 'block';
        }

        // Sign in with Google button click
        function signInWithGoogle() {
            if (typeof google !== 'undefined' && google.accounts) {
                google.accounts.id.prompt();
            } else {
                // Fallback: Use OAuth popup
                const redirectUri = 'https://making-cv.vercel.app/';
                const scope = 'email profile';
                const authUrl = `https://accounts.google.com/o/oauth2/auth?client_id=${GOOGLE_CLIENT_ID}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=token&scope=${encodeURIComponent(scope)}`;
                window.open(authUrl, '_blank', 'width=500,height=600');
            }
        }

        // Complete purchase - save subscription
        async function completePurchase() {
            const token = localStorage.getItem('mycv_token');

            if (!token) {
                alert('ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู ุฃููุงู');
                return;
            }

            try {
                // Save subscription to backend
                const response = await fetch('api/pricing.php?action=purchase', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        plan: paymentType,
                        payment_method: 'direct'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Update local user data
                    if (currentUserData) {
                        currentUserData.subscription_type = paymentType;
                        currentUserData.subscription_expires = data.expires_at;
                        localStorage.setItem('mycv_user', JSON.stringify(currentUserData));
                    }

                    userSubscription = paymentType;
                    closeModal('paymentModal');
                    showSuccess('ุชู ุชูุนูู ุงุดุชุฑุงูู ุจูุฌุงุญ! ๐');

                    // Download CV without watermark
                    setTimeout(() => generatePDF(false), 1500);
                } else {
                    alert(data.error || 'ุญุฏุซ ุฎุทุฃ ูู ุชูุนูู ุงูุงุดุชุฑุงู');
                }
            } catch (error) {
                console.error('Purchase error:', error);
                // Fallback - allow purchase locally for demo
                userSubscription = paymentType;
                closeModal('paymentModal');
                showSuccess('ุชู ุชูุนูู ุงุดุชุฑุงูู ุจูุฌุงุญ! ๐');
                setTimeout(() => generatePDF(false), 1500);
            }
        }

        // Update showPayment function
        const originalShowPayment = showPayment;
        showPayment = function (type) {
            paymentType = type;
            closeModal('downloadModal');

            const prices = { single: 5, monthly: 29, business: 199 };
            const priceUSD = { single: 1.5, monthly: 8, business: 53 };
            const price = prices[type] || 29;

            const texts = {
                'single': `ุชุญููู ุณูุฑุฉ ุฐุงุชูุฉ ูุงุญุฏุฉ ุจุฏูู ุนูุงูุฉ ูุงุฆูุฉ - ${price} ุฑูุงู`,
                'monthly': `ุงุดุชุฑุงู ุดูุฑู - ุชุญูููุงุช ุบูุฑ ูุญุฏูุฏุฉ - ${price} ุฑูุงู/ุดูุฑ`,
                'business': `ุจุงูุฉ ุงูุดุฑูุงุช - 50 ูุณุชุฎุฏู + ุชูุงุฑูุฑ - ${price} ุฑูุงู/ุดูุฑ`
            };
            document.getElementById('paymentInfo').textContent = texts[type] || texts.monthly;

            // Check if user is already logged in
            if (isLoggedIn && currentUserData) {
                showUserLoggedIn(currentUserData);
            } else {
                document.getElementById('googleLoginSection').style.display = 'block';
                document.getElementById('userProfileBox').style.display = 'none';
                document.getElementById('paymentMethods').style.display = 'none';
            }

            document.getElementById('paymentModal').classList.add('active');
        };

        // Initialize Google Sign-In when loaded
        window.addEventListener('load', () => {
            setTimeout(initGoogleSignIn, 500);
        });
    </script>
</body>

</html>
